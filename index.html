<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ðŸ”¥ FIREBASE CONFIG BARU
const firebaseConfig = {
  apiKey: "AIzaSyCKX6uS1motUTc5EGX1PnB9c9nHiu00438",
  authDomain: "showcase-itsbad.firebaseapp.com",
  projectId: "showcase-itsbad",
  storageBucket: "showcase-itsbad.firebasestorage.app",
  messagingSenderId: "1041967882961",
  appId: "1:1041967882961:web:941e45e75fcee0c2d95bf0",
  measurementId: "G-3TLH4LEGN7"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

let isAdmin = false;
let allProducts = [];
let currentPlatform = null;
let isEditing = false;

// ðŸ”¥ MANUAL AI SYSTEM
function manualAI(title, desc) {
    let score = 50;

    if (title.length > 20) score -= 10;
    if (desc.length > 50) score -= 10;

    const keywords = ["best", "promo", "terlaris", "viral", "murah"];
    keywords.forEach(k => {
        if (title.toLowerCase().includes(k)) score -= 15;
    });

    if (score < 1) score = 1;
    if (score > 100) score = 100;

    return score;
}

// ðŸ”¥ REALTIME LISTENER
function setupRealtimeData() {
    const q = collection(db, "products");
    onSnapshot(q, (snapshot) => {
        allProducts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        if (currentPlatform) renderGrid();
    });
}
setupRealtimeData();

// ðŸ”¥ VIEW SWITCH
window.switchView = (view, platform = null) => {
    document.getElementById('landing-view').classList.add('hidden');
    document.getElementById('showcase-view').classList.add('hidden');

    if (view === 'landing') {
        document.getElementById('landing-view').classList.remove('hidden');
        currentPlatform = null;
    } else {
        document.getElementById('showcase-view').classList.remove('hidden');
        currentPlatform = platform;
        document.getElementById('platform-title-nav').innerText = platform.toUpperCase() + " HUB";
        renderGrid();
    }

    window.scrollTo(0,0);
    lucide.createIcons();
};

// ðŸ”¥ LOGIN ADMIN
document.getElementById('login-form').onsubmit = (e) => {
    e.preventDefault();
    if (document.getElementById('login-pass').value === '110603') {
        isAdmin = true;
        toggleLoginModal(false);
        document.getElementById('admin-panel').classList.remove('hidden');
        document.getElementById('admin-indicator').classList.remove('hidden');
        document.getElementById('spacer-nav').classList.add('hidden');
        renderGrid();
    } else {
        alert("Password Salah!");
    }
};

window.logoutAdmin = () => {
    isAdmin = false;
    document.getElementById('admin-panel').classList.add('hidden');
    document.getElementById('admin-indicator').classList.add('hidden');
    document.getElementById('spacer-nav').classList.remove('hidden');
    renderGrid();
};

// ðŸ”¥ PRODUCT FORM
document.getElementById('product-form').onsubmit = async (e) => {
    e.preventDefault();

    if (!isAdmin) {
        alert("Login admin dulu.");
        return;
    }

    const title = document.getElementById('in-title').value;
    const desc = document.getElementById('in-desc').value;
    const link = document.getElementById('in-link').value;
    const image = document.getElementById('in-image').value;
    let order = parseInt(document.getElementById('in-order').value);

    if (order === 0 || isNaN(order)) {
        document.getElementById('ai-status').classList.remove('hidden');
        order = manualAI(title, desc);
        setTimeout(() => {
            document.getElementById('ai-status').classList.add('hidden');
        }, 800);
    }

    const payload = {
        title,
        description: desc,
        sortOrder: order,
        link,
        image,
        platform: currentPlatform,
        createdAt: new Date()
    };

    try {
        if (isEditing) {
            const id = document.getElementById('edit-id').value;
            await updateDoc(doc(db, "products", id), payload);
        } else {
            await addDoc(collection(db, "products"), payload);
        }

        resetForm();
    } catch (err) {
        alert("Gagal simpan: " + err.message);
    }
};

// ðŸ”¥ EDIT
window.startEdit = (id) => {
    const p = allProducts.find(x => x.id === id);
    if (!p) return;

    isEditing = true;
    document.getElementById('edit-id').value = p.id;
    document.getElementById('in-title').value = p.title;
    document.getElementById('in-desc').value = p.description;
    document.getElementById('in-link').value = p.link;
    document.getElementById('in-image').value = p.image || '';
    document.getElementById('in-order').value = p.sortOrder;

    document.getElementById('btn-submit').innerText = 'Update Produk';
};

// ðŸ”¥ DELETE
window.deleteProd = async (id) => {
    if (confirm("Hapus produk ini?")) {
        await deleteDoc(doc(db, "products", id));
    }
};

// ðŸ”¥ RESET
window.resetForm = () => {
    isEditing = false;
    document.getElementById('product-form').reset();
    document.getElementById('edit-id').value = '';
    document.getElementById('btn-submit').innerText = 'Simpan Data';
};

// ðŸ”¥ RENDER GRID
function renderGrid() {
    const grid = document.getElementById('product-grid');
    const empty = document.getElementById('empty-msg');

    const filtered = allProducts
        .filter(p => p.platform === currentPlatform)
        .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

    if (filtered.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');

    grid.innerHTML = filtered.map((p, i) => `
        <div class="bg-neutral-900/40 rounded-3xl border border-white/5 overflow-hidden hover:-translate-y-2 transition-all duration-500">
            <div class="aspect-square bg-black overflow-hidden">
                <img src="${p.image || 'https://images.unsplash.com/photo-1550745165-9bc0b252726f'}"
                     class="w-full h-full object-cover hover:scale-110 transition-transform duration-700">
            </div>
            <div class="p-6">
                <h4 class="text-lg font-bold mb-2">${p.title}</h4>
                <p class="text-neutral-500 text-xs mb-4">${p.description || "Tidak ada deskripsi."}</p>
                <a href="${p.link}" target="_blank"
                   class="block text-center py-3 bg-white text-black rounded-xl font-bold hover:bg-purple-600 hover:text-white transition-all">
                   Beli Produk
                </a>
            </div>
        </div>
    `).join('');
}
</script>
